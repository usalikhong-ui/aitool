<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字RPG - 存檔/讀檔範例</title>
    <!-- 引入 Tailwind CSS 以進行快速樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 CryptoJS 庫以進行加密/解密 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <!-- 遊戲主畫面 -->
        <div>
            <h1 class="text-3xl font-bold text-cyan-400 mb-2">迷霧森林的深處</h1>
            <div id="game-text" class="bg-gray-900/50 p-4 rounded-lg min-h-[150px] border border-gray-700 text-lg leading-relaxed">
                <!-- 遊戲文字將會顯示在這裡 -->
            </div>
        </div>

        <!-- 玩家選項 -->
        <div id="choices" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 遊戲選項按鈕將會顯示在這裡 -->
        </div>
        
        <!-- 玩家狀態 -->
        <div id="player-stats" class="text-md text-gray-400 border-t border-gray-700 pt-4">
            <!-- 玩家狀態將會顯示在這裡 -->
        </div>

        <!-- 存檔/讀檔區塊 -->
        <div class="bg-gray-700/50 p-5 rounded-lg space-y-4 border border-gray-600">
            <h2 class="text-xl font-semibold text-white">遊戲進度管理</h2>
            
            <!-- 訊息提示 -->
            <div id="message-area" class="text-center p-2 rounded-md text-sm font-medium transition-opacity duration-300 opacity-0"></div>

            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input type="password" id="password-input" placeholder="請輸入存檔/讀取密碼" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition">
                
                <div class="flex gap-2 w-full md:w-auto">
                    <button id="save-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-transform transform hover:scale-105">
                        儲存
                    </button>
                    <button id="load-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-transform transform hover:scale-105">
                        讀取
                    </button>
                </div>
            </div>
            <p class="text-xs text-gray-500 text-center md:text-left">存檔會覆蓋之前的紀錄。請務必記住你的密碼。</p>
        </div>
    </div>

    <script>
        // --- DOM 元素獲取 ---
        const gameTextEl = document.getElementById('game-text');
        const choicesEl = document.getElementById('choices');
        const playerStatsEl = document.getElementById('player-stats');
        const saveButton = document.getElementById('save-button');
        const loadButton = document.getElementById('load-button');
        const passwordInput = document.getElementById('password-input');
        const messageArea = document.getElementById('message-area');

        // --- 遊戲核心資料 ---

        // 玩家狀態物件
        let player = {
            name: "冒險者",
            hp: 100,
            maxHp: 100,
            inventory: [],
            currentScene: 'start' // 玩家目前的場景ID
        };

        // 遊戲場景與故事數據
        const gameData = {
            'start': {
                text: "你在一片迷霧繚繞的森林中醒來，四周靜得可怕。你看到兩條小徑，一條通往左邊的陰暗洞穴，另一條則延伸到右邊的潺潺溪流。",
                choices: [
                    { text: "探索左邊的洞穴", nextScene: 'cave' },
                    { text: "走向右邊的溪流", nextScene: 'stream' }
                ]
            },
            'cave': {
                text: "洞穴裡又濕又冷，深處傳來奇怪的聲響。在地上，你發現了一把生鏽的舊鑰匙。",
                choices: [
                    { text: "撿起鑰匙", nextScene: 'cave_with_key', effect: () => { 
                        if (!player.inventory.includes('舊鑰匙')) {
                            player.inventory.push('舊鑰匙');
                        }
                    }},
                    { text: "害怕，離開洞穴", nextScene: 'start' }
                ]
            },
            'cave_with_key': {
                text: "你拿著鑰匙，感覺心安了一些。洞穴深處的聲音似乎更近了。",
                choices: [
                    { text: "繼續深入探索", nextScene: 'monster' },
                    { text: "離開洞穴", nextScene: 'start' }
                ]
            },
            'stream': {
                text: "溪水清澈見底，喝下幾口後，你感覺精神恢復了。水中似乎有閃閃發光的東西。",
                choices: [
                    { text: "恢復體力", nextScene: 'stream', effect: () => { player.hp = Math.min(player.maxHp, player.hp + 20); }},
                    { text: "離開溪邊", nextScene: 'start' }
                ]
            },
            'monster': {
                text: "一隻巨大的洞穴蜘蛛擋住了你的去路！",
                choices: [
                    { text: "戰鬥！", nextScene: 'end_bad' },
                    { text: "逃跑！", nextScene: 'start', effect: () => { player.hp -= 30; } }
                ]
            },
            'end_bad': {
                text: "你奮力抵抗，但最終不敵蜘蛛。你的冒險到此為止了...",
                choices: [
                    { text: "重新開始", nextScene: 'start', effect: () => resetGame() }
                ]
            }
        };

        // --- 遊戲功能函數 ---

        /** 重置遊戲到初始狀態 */
        function resetGame() {
            player = {
                name: "冒險者",
                hp: 100,
                maxHp: 100,
                inventory: [],
                currentScene: 'start'
            };
        }

        /** 顯示提示訊息 */
        function showMessage(text, isError = false) {
            messageArea.textContent = text;
            messageArea.classList.remove('opacity-0', 'bg-green-500', 'text-green-900', 'bg-red-500', 'text-red-900');
            if (isError) {
                messageArea.classList.add('bg-red-500', 'text-red-900');
            } else {
                messageArea.classList.add('bg-green-500', 'text-green-900');
            }
            messageArea.classList.add('opacity-100');

            setTimeout(() => {
                messageArea.classList.remove('opacity-100');
                messageArea.classList.add('opacity-0');
            }, 3000);
        }
        
        /** 更新玩家狀態顯示 */
        function updatePlayerStats() {
            playerStatsEl.innerHTML = `
                <span>生命值: <span class="font-semibold text-white">${player.hp} / ${player.maxHp}</span></span>
                <span class="ml-4">物品: <span class="font-semibold text-white">${player.inventory.length > 0 ? player.inventory.join(', ') : '無'}</span></span>
            `;
        }

        /** 渲染指定場景 */
        function renderScene(sceneId) {
            const scene = gameData[sceneId];
            if (!scene) {
                console.error(`找不到場景: ${sceneId}`);
                return;
            }

            player.currentScene = sceneId;
            gameTextEl.textContent = scene.text;
            choicesEl.innerHTML = ''; // 清空舊選項

            scene.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = "bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition-transform transform hover:scale-105";
                button.onclick = () => {
                    if (choice.effect) {
                        choice.effect();
                    }
                    renderScene(choice.nextScene);
                };
                choicesEl.appendChild(button);
            });
            
            updatePlayerStats();
        }

        // --- 存檔/讀檔邏輯 ---

        const SAVE_KEY = 'textRPGSaveData'; // 在 localStorage 中儲存的鍵名

        /** 儲存遊戲 */
        function saveGame() {
            const password = passwordInput.value;
            if (!password) {
                showMessage("儲存失敗：請輸入密碼！", true);
                return;
            }

            try {
                // 1. 將玩家物件轉換為 JSON 字串
                const saveData = JSON.stringify(player);
                // 2. 使用密碼對 JSON 字串進行 AES 加密
                const encryptedData = CryptoJS.AES.encrypt(saveData, password).toString();
                // 3. 將加密後的字串（這就是你的"代碼"）儲存到 localStorage
                localStorage.setItem(SAVE_KEY, encryptedData);
                
                showMessage("遊戲進度已成功儲存！");
                passwordInput.value = '';
            } catch (e) {
                showMessage("儲存時發生未知錯誤。", true);
                console.error("Save error:", e);
            }
        }

        /** 讀取遊戲 */
        function loadGame() {
            const password = passwordInput.value;
            if (!password) {
                showMessage("讀取失敗：請輸入密碼！", true);
                return;
            }

            const encryptedData = localStorage.getItem(SAVE_KEY);
            if (!encryptedData) {
                showMessage("沒有找到任何存檔記錄。", true);
                return;
            }

            try {
                // 1. 使用密碼嘗試解密數據
                const bytes = CryptoJS.AES.decrypt(encryptedData, password);
                // 2. 將解密後的數據轉回 UTF-8 字串
                const decryptedData = bytes.toString(CryptoJS.enc.Utf8);

                // 如果解密後是空字串，代表密碼錯誤
                if (!decryptedData) {
                    throw new Error("Incorrect password");
                }

                // 3. 將 JSON 字串解析回玩家物件
                const loadedPlayerState = JSON.parse(decryptedData);
                
                // 4. 更新當前遊戲狀態
                player = loadedPlayerState;
                
                // 5. 重新渲染遊戲場景
                renderScene(player.currentScene);
                
                showMessage("遊戲進度已成功讀取！");
                passwordInput.value = '';

            } catch (e) {
                showMessage("讀取失敗：密碼錯誤或存檔已損毀。", true);
                console.error("Load error:", e);
            }
        }

        // --- 事件監聽 ---
        saveButton.addEventListener('click', saveGame);
        loadButton.addEventListener('click', loadGame);

        // --- 遊戲初始化 ---
        renderScene('start');

    </script>
</body>
</html>

