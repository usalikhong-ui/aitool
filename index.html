<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>ç­”æ¡ˆä¹‹æ›¸ RPGï¼ˆé»é™£ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#0f1220; --panel:#1b2140; --text:#e8eeff; --accent:#86a5ff; --muted:#a8b2d1;
    --btn:#2a3560; --btn2:#364276; --ok:#3ea86a; --warn:#e6b450; --coin: #f1c40f;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,"PingFang TC","Noto Sans TC",sans-serif;touch-action:none;}
  #gameWrap{position:fixed;inset:0;display:flex;flex-direction:column;}
  /* é ‚éƒ¨è³‡è¨Šæ¢ */
  .topbar{height:44px;display:flex;align-items:center;gap:10px;padding:0 10px;background:linear-gradient(#121736,#0f142f);border-bottom:1px solid #1c2447}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#151b36;color:var(--muted);font-size:12px}
  .pill b{color:var(--text);font-weight:600}
  .icon{width:14px;height:14px;display:inline-block}
  /* ç•«å¸ƒå€ */
  #stage{flex:1;position:relative;overflow:hidden}
  canvas#map{position:absolute;inset:0;margin:auto;image-rendering:pixelated;background:linear-gradient(#1a1f39,#13182b)}
  /* åº•éƒ¨é¢æ¿ */
  .bottombar{min-height:80px;padding:10px;background:linear-gradient(#0e142e,#0c1124);border-top:1px solid #1c2447;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{background:var(--btn);border:1px solid #3a467c;color:var(--text);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer;}
  button:active{transform:translateY(1px)}
  button:disabled{background:#1e2648;color:var(--muted);cursor:not-allowed;transform:none;}
  .btn-ok{background:var(--ok);border-color:#409e6a}
  .btn-secondary{background:var(--btn2)}
  .btn-warn{background:var(--warn); border-color:#c89f41;}
  /* è¨Šæ¯çª— */
  .msg{flex:1;min-width:180px;background:var(--panel);border:1px solid #2a335f;border-radius:12px;padding:10px;font-size:14px;max-height:72px;overflow:auto}
  .muted{color:var(--muted);font-size:12px}
  /* è¡Œå‹•è£ç½®è™›æ“¬æ–¹å‘éµ */
  .hud{position:absolute;inset:0;pointer-events:none}
  .dpad{position:absolute;left:12px;bottom:12px;width:160px;height:160px;pointer-events:auto;touch-action:none}
  .dpad button{position:absolute;width:56px;height:56px;border-radius:12px;background:#222c55;border:1px solid #304078}
  .dpad .up{left:52px;top:0}
  .dpad .down{left:52px;bottom:0}
  .dpad .left{left:0;top:52px}
  .dpad .right{right:0;top:52px}
  /* é€šç”¨é¢æ¿ */
  .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid #2a335f;padding:14px 12px;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -10px 40px #0008;transform:translateY(110%);transition:transform .25s ease;z-index:10; max-height: 60vh; overflow-y: auto;}
  .sheet.open{transform:translateY(0)}
  .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .item{padding:10px;border:1px solid #334074;border-radius:12px}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#22305f;color:#aecdff}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  /* æ›¸æœ¬é–±è®€å™¨ */
  #bookReader{position:fixed;inset:10px;background:var(--panel);border-radius:16px;z-index:20;padding:20px;display:none;flex-direction:column;border:1px solid #2a335f;}
  #bookReader.open{display:flex;}
  #bookTitle{font-size:1.2em;font-weight:bold;margin-bottom:10px;color:var(--accent);}
  #bookContent{flex:1;overflow:auto;font-size:15px;line-height:1.7;white-space:pre-wrap;padding-right:10px;}
  #bookNav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
  #pageIndicator{font-size:14px;}

  /* å°è¢å¹•å„ªåŒ– */
  @media (max-width:520px){
    .bottombar{gap:8px; justify-content: center;}
    button{padding:10px 10px; font-size: 14px;}
    .msg{max-height:66px;min-width:100%; order: 1;}
  }
</style>
</head>
<body>
<div id="gameWrap">
  <!-- é ‚éƒ¨è³‡è¨Š -->
  <div class="topbar">
    <span class="pill" id="timePill"><span class="icon" id="dayIcon"></span><b id="clock">--:--</b></span>
    <span class="pill" id="tempPill"><span data-lang="ui_temp">æ°£æº«</span> <b id="temp">--Â°</b></span>
    <span class="pill"><span style="color:var(--coin)">ğŸ’°</span> <b id="goldDisplay">10</b></span>
    <span class="pill"><span class="icon" style="background:radial-gradient(circle at 50% 40%,#ffeaa7 0 50%,#0000 51%), radial-gradient(#ffd06b 55%,#0000 56%);border-radius:50%"></span><span class="muted" data-lang="ui_daily_reset">æ¯æ—¥é‡ç½®</span> <b id="resetCountdown">--:--:--</b></span>
    <span class="pill" id="langSwitcher" style="cursor:pointer; margin-left: auto;"><span data-lang="ui_lang">èªè¨€</span>: <b id="langDisplay">ç¹</b></span>
  </div>

  <!-- èˆå° -->
  <div id="stage">
    <canvas id="map" width="320" height="180"></canvas>
    <div class="hud">
      <div class="dpad" id="dpad">
        <button class="up"   data-dir="up">â–²</button>
        <button class="down" data-dir="down">â–¼</button>
        <button class="left" data-dir="left">â—€</button>
        <button class="right"data-dir="right">â–¶</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨æ“ä½œ -->
  <div class="bottombar">
    <button id="answerBtn" class="btn-ok" data-lang="btn_answer">ä»Šå¤©ç­”æ¡ˆ</button>
    <button id="drawEquipBtn" class="btn-warn" data-lang="btn_draw_equip">æŠ½è£å‚™</button>
    <button id="nameBtn" class="btn-secondary" data-lang="btn_name">åå­—</button>
    <button id="petBtn" class="btn-secondary" data-lang="btn_pet">å¯µç‰©</button>
    <button id="backpackBtn" class="btn-secondary" data-lang="btn_backpack">èƒŒåŒ…</button>
    <button id="gearBtn" class="btn-secondary" data-lang="btn_gear">è£å‚™</button>
    <div class="msg" id="msgBox"><div class="muted" data-lang="hint_welcome">æ¢ç´¢ä½ çš„å°ç©ºé–“å§ï¼</div></div>
  </div>
</div>

<!-- é¢æ¿ -->
<div class="sheet" id="gearSheet" aria-hidden="true">
  <div class="row" style="justify-content:space-between;margin-bottom:8px">
    <div><b data-lang="gear_title">è£å‚™</b> <span class="small" data-lang="gear_subtitle">ï¼ˆé»æŒ‰åˆ‡æ›ç©¿è‘—ï¼‰</span></div>
    <button class="close-btn" data-panel="gearSheet" data-lang="btn_close">é—œé–‰</button>
  </div>
  <div class="grid" id="gearGrid"></div>
</div>

<div class="sheet" id="petSheet" aria-hidden="true">
  <div class="row" style="justify-content:space-between;margin-bottom:8px">
    <div><b data-lang="pet_title">å¯µç‰©</b> <span class="small" data-lang="pet_subtitle">ï¼ˆé»æŒ‰å¬å–š/éš±è—ï¼‰</span></div>
    <button class="close-btn" data-panel="petSheet" data-lang="btn_close">é—œé–‰</button>
  </div>
  <div class="grid" id="petGrid"></div>
</div>

<div class="sheet" id="backpackSheet" aria-hidden="true">
  <div class="row" style="justify-content:space-between;margin-bottom:8px">
    <div><b data-lang="backpack_title">èƒŒåŒ…</b> <span class="small" data-lang="backpack_subtitle">ï¼ˆé»æŒ‰é–±è®€å·²è³¼è²·çš„æ›¸ï¼‰</span></div>
    <button class="close-btn" data-panel="backpackSheet" data-lang="btn_close">é—œé–‰</button>
  </div>
  <div class="grid" id="backpackGrid"></div>
</div>

<div class="sheet" id="shopSheet" aria-hidden="true">
  <div class="row" style="justify-content:space-between;margin-bottom:8px">
    <div><b data-lang="shop_title">æ›¸åº—</b> <span class="small" data-lang="shop_subtitle">ï¼ˆèˆ‡æˆ‘è³¼è²·æ™ºæ…§å§ï¼ï¼‰</span></div>
    <button class="close-btn" data-panel="shopSheet" data-lang="btn_close">é—œé–‰</button>
  </div>
  <div class="grid" id="shopGrid"></div>
</div>

<div class="sheet" id="nameSheet" aria-hidden="true">
  <div class="row" style="justify-content:space-between;margin-bottom:8px">
    <div><b data-lang="name_title">æ›´æ”¹åå­—</b></div>
    <button class="close-btn" data-panel="nameSheet" data-lang="btn_close">é—œé–‰</button>
  </div>
  <div class="row" style="gap: 8px;">
    <input type="text" id="nameInput" placeholder="è¼¸å…¥ä½ çš„åå­—" style="flex:1; padding: 8px; border-radius: 8px; border: 1px solid #334074; background: var(--bg); color: var(--text);">
    <button id="saveNameBtn" data-lang="btn_save">å„²å­˜</button>
  </div>
</div>

<!-- æ›¸æœ¬é–±è®€å™¨ -->
<div id="bookReader">
  <h3 id="bookTitle"></h3>
  <div id="bookContent"></div>
  <div id="bookNav">
    <button id="prevPageBtn" data-lang="btn_prev_page">ä¸Šä¸€é </button>
    <span id="pageIndicator"></span>
    <button id="nextPageBtn" data-lang="btn_next_page">ä¸‹ä¸€é </button>
  </div>
   <button id="closeBookBtn" data-lang="btn_close" style="margin-top: 10px; width:100%;">é—œé–‰</button>
</div>

<script src="books.js"></script>
<script>
// Wrap entire game logic in a function to be called after books.js is loaded
function initializeGame() {
  /* =============================
     ç’°å¢ƒèˆ‡å·¥å…·
  ============================= */
  const $ = sel => document.querySelector(sel);
  const map = $('#map'), ctx = map.getContext('2d');
  const stage = $('#stage'), msgBox = $('#msgBox'), dpad = $('#dpad');
  const isTouch = matchMedia('(pointer:coarse)').matches;
  let isDay = true;
  let effects = [];
  let eatingEffect = { active: false, timer: 0, duration: 120 };

  /* =============================
     èªè¨€èˆ‡åœ¨åœ°åŒ–
  ============================= */
  const LANG_STRINGS = {
    'zh-TW': {
      ui_temp: 'æ°£æº«', ui_daily_reset: 'æ¯æ—¥é‡ç½®', ui_lang: 'èªè¨€', lang_symbol: 'ç¹',
      btn_answer: 'ä»Šå¤©ç­”æ¡ˆ', btn_answer_done: 'å·²ç²ç­”æ¡ˆ', btn_draw_equip: 'æŠ½è£å‚™', btn_draw_done: 'ä»Šæ—¥å·²æŠ½', btn_gear: 'è£å‚™', btn_close: 'é—œé–‰', btn_pet: 'å¯µç‰©', btn_backpack: 'èƒŒåŒ…', btn_prev_page: 'ä¸Šä¸€é ', btn_next_page: 'ä¸‹ä¸€é ', btn_buy: 'è³¼è²·', btn_read: 'é–±è®€', btn_name: 'åå­—', btn_save: 'å„²å­˜',
      gear_title: 'è£å‚™', gear_subtitle: 'ï¼ˆé»æŒ‰åˆ‡æ›ç©¿è‘—ï¼‰', btn_equip: 'ç©¿ä¸Š', btn_unequip: 'è„«ä¸‹',
      pet_title: 'å¯µç‰©', pet_subtitle: 'ï¼ˆé»æŒ‰å¬å–š/éš±è—ï¼‰', btn_summon: 'å¬å–š', btn_unsummon: 'éš±è—',
      backpack_title: 'èƒŒåŒ…', backpack_subtitle: 'ï¼ˆé»æŒ‰é–±è®€å·²è³¼è²·çš„æ›¸ï¼‰', backpack_empty: 'ä½ çš„èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿã€‚',
      shop_title: 'æ›¸åº—', shop_subtitle: 'ï¼ˆèˆ‡æˆ‘è³¼è²·æ™ºæ…§å§ï¼ï¼‰', btn_owned: 'å·²æ“æœ‰',
      name_title: 'æ›´æ”¹åå­—',
      type_head: 'é ­éƒ¨', type_eyes: 'çœ¼éƒ¨', type_body: 'èº«é«”', type_legs: 'è…¿éƒ¨',
      hint_welcome: 'æ¢ç´¢ä½ çš„å°ç©ºé–“å§ï¼',
      hint_sit: 'ä½ ååœ¨æ¡Œé‚Š... æŒ‰ä»»æ„æ–¹å‘éµé›¢é–‹ã€‚',
      hint_sleep: 'ä½ èººåœ¨åºŠä¸Šä¼‘æ¯... æŒ‰ä»»æ„æ–¹å‘éµèµ·åºŠã€‚',
      hint_read: 'ä½ æ­£åœ¨é–±è®€... æŒ‰ä»»æ„æ–¹å‘éµåœæ­¢ã€‚',
      hint_new_item: 'æ­å–œä½ æŠ½åˆ°æ–°è£å‚™ï¼š<b>{itemName}</b>ï¼',
      hint_all_items: 'æ­å–œï¼ä½ å·²æ”¶é›†æ‰€æœ‰è£å‚™ï¼',
      hint_buy_book: 'ä½ èŠ±äº† {price} é‡‘å¹£è²·ä¸‹äº†ã€Š{bookName}ã€‹ã€‚',
      hint_no_gold: 'é‡‘å¹£ä¸è¶³ï¼',
      answer_title: 'ä»Šæ—¥ç­”æ¡ˆ',
      answer_A: ["ä½ å·²ç¶“èµ°åœ¨è·¯ä¸Š","æŠŠç›®å…‰æ”¾é ä¸€é»","æ…¢æ…¢ä¾†ä¹Ÿæ²’é—œä¿‚","ä»Šå¤©è«‹æº«æŸ”å°è‡ªå·±","å…ˆå®Œæˆä¸€ä»¶å°äº‹","æŠŠå¿ƒå®‰æ”¾å¥½","å‹‡æ•¢ï¼Œä½†ä¸é€å¼·","ç›¸ä¿¡æ­¥ä¼çš„åŠ›é‡","æŠŠå¤±æ•—ç•¶ä½œå›é¥‹","è©¦è‘—å¾®ç¬‘ä¸€ä¸‹","æ¥ç´ä¸ç¢ºå®š","å…è¨±è‡ªå·±ä¼‘æ¯","å…ˆå‘¼å¸ï¼Œå†å‡ºç™¼","åˆ¥å¿˜äº†è£œæ°´","æŠŠæƒ…ç·’èªªå‡ºä¾†","å …æŒä½ èªåŒçš„ç¯€å¥","å»æ•£æ­¥äº”åˆ†é˜","å¯«ä¸‹ä½ æ„Ÿè¬çš„ä¸‰ä»¶äº‹","ä½ å€¼å¾—è¢«å–„å¾…","ä»Šå¤©çš„ä½ ï¼Œå·²è¶³å¤ å¥½"],
      answer_B: ["æ˜å¤©æœƒæ›´æ¸…æ™°","ç­”æ¡ˆæœƒåœ¨è·¯ä¸Šå‡ºç¾","åŠªåŠ›ä¸ä¸€å®šç«‹åˆ»æœ‰æ•ˆ","å€¼å¾—çš„äº‹éƒ½éœ€è¦æ™‚é–“","æ”¾ä¸‹å®Œç¾ä¸»ç¾©","æŠŠç„¦é»æ”¾åœ¨å¯è¡Œä¸€æ­¥","å…ˆåšèƒ½åšçš„","ä½ å¯ä»¥æ±‚åŠ©","ç”¨å¥½å¥‡æ›¿ä»£ææ‡¼","æŠŠæ¨™æº–èª¿æ•´åˆ°å¯é”","è«‹ç›¸ä¿¡è‡ªå·±çš„æ¢å¾©åŠ›","æŠŠæ³¨æ„åŠ›å›åˆ°ç•¶ä¸‹","æŠŠç›®å…‰å¾çµæœç§»é–‹","è®“èº«é«”å‘Šè¨´ä½ ç•Œç·š","æŠŠå¿™ç¢Œè®Šæˆå°ˆæ³¨","ç·´ç¿’èªªä¸"],
      answer_C: ["ä»Šå¤©å·²ç¶“è¶³å¤ åŠªåŠ›ï¼Œæœªä¾†æ‰æœ€ç·Šè¦ã€‚","æ­¤åˆ»çš„å®‰å®šï¼Œæ¯”ä»€éº¼éƒ½çè²´ã€‚","ä¿æŒå–„è‰¯èˆ‡ç•Œç·šï¼Œå…©è€…éƒ½è¦ã€‚","ä½ ä¸æ˜¯ä¸€å€‹äººï¼ŒçœŸçš„ã€‚","æ”¾éè‡ªå·±ä¸€æ¬¡è©¦è©¦ã€‚","å¿ƒè»¸ç©©äº†ï¼Œè·¯å°±ä¸æ™ƒäº†ã€‚","æŠŠåŠ›é‡ç•™çµ¦é‡è¦çš„äººèˆ‡äº‹ã€‚","é¡˜ä½ åœ¨é‡è¦è™•æ¸…é†’ï¼Œåœ¨ç´°ç¢è™•æŸ”è»Ÿã€‚","å°‘æ¯”è¼ƒï¼Œå¤šè¡Œå‹•ã€‚","æ…¢ï¼Œä½†å …å®šã€‚"],
      answer_tags: ["#å°ˆæ³¨","#è£œæ°´","#å‘¼å¸","#æ”¾é¬†","#è¡Œä¸€å°æ­¥","#ç•Œç·š","#è€å¿ƒ","#æ„Ÿè¬","#ç¡çœ ","#æº«æŸ”","#ç›¸ä¿¡","#æ•´ç†"],
    },
    'zh-CN': {
      ui_temp: 'æ°”æ¸©', ui_daily_reset: 'æ¯æ—¥é‡ç½®', ui_lang: 'è¯­è¨€', lang_symbol: 'ç®€',
      btn_answer: 'ä»Šå¤©ç­”æ¡ˆ', btn_answer_done: 'å·²è·ç­”æ¡ˆ', btn_draw_equip: 'æŠ½è£…å¤‡', btn_draw_done: 'ä»Šæ—¥å·²æŠ½', btn_gear: 'è£…å¤‡', btn_close: 'å…³é—­', btn_pet: 'å® ç‰©', btn_backpack: 'èƒŒåŒ…', btn_prev_page: 'ä¸Šä¸€é¡µ', btn_next_page: 'ä¸‹ä¸€é¡µ', btn_buy: 'è´­ä¹°', btn_read: 'é˜…è¯»', btn_name: 'åå­—', btn_save: 'ä¿å­˜',
      gear_title: 'è£…å¤‡', gear_subtitle: 'ï¼ˆç‚¹å‡»åˆ‡æ¢ç©¿ç€ï¼‰', btn_equip: 'ç©¿ä¸Š', btn_unequip: 'è„±ä¸‹',
      pet_title: 'å® ç‰©', pet_subtitle: 'ï¼ˆç‚¹å‡»å¬å”¤/éšè—ï¼‰', btn_summon: 'å¬å”¤', btn_unsummon: 'éšè—',
      backpack_title: 'èƒŒåŒ…', backpack_subtitle: 'ï¼ˆç‚¹å‡»é˜…è¯»å·²è´­ä¹°çš„ä¹¦ï¼‰', backpack_empty: 'ä½ çš„èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿã€‚',
      shop_title: 'ä¹¦åº—', shop_subtitle: 'ï¼ˆä¸æˆ‘è´­ä¹°æ™ºæ…§å§ï¼ï¼‰', btn_owned: 'å·²æ‹¥æœ‰',
      name_title: 'æ›´æ”¹åå­—',
      type_head: 'å¤´éƒ¨', type_eyes: 'çœ¼éƒ¨', type_body: 'èº«ä½“', type_legs: 'è…¿éƒ¨',
      hint_welcome: 'æ¢ç´¢ä½ çš„å°ç©ºé—´å§ï¼',
      hint_sit: 'ä½ ååœ¨æ¡Œè¾¹... æŒ‰ä»»æ„æ–¹å‘é”®ç¦»å¼€ã€‚',
      hint_sleep: 'ä½ èººåœ¨åºŠä¸Šä¼‘æ¯... æŒ‰ä»»æ„æ–¹å‘é”®èµ·åºŠã€‚',
      hint_read: 'ä½ æ­£åœ¨é˜…è¯»... æŒ‰ä»»æ„æ–¹å‘é”®åœæ­¢ã€‚',
      hint_new_item: 'æ­å–œä½ æŠ½åˆ°æ–°è£…å¤‡ï¼š<b>{itemName}</b>ï¼',
      hint_all_items: 'æ­å–œï¼ä½ å·²æ”¶é›†æ‰€æœ‰è£…å¤‡ï¼',
      hint_buy_book: 'ä½ èŠ±äº† {price} é‡‘å¸ä¹°ä¸‹äº†ã€Š{bookName}ã€‹ã€‚',
      hint_no_gold: 'é‡‘å¸ä¸è¶³ï¼',
      answer_title: 'ä»Šæ—¥ç­”æ¡ˆ',
      answer_A: ["ä½ å·²ç»èµ°åœ¨è·¯ä¸Š","æŠŠç›®å…‰æ”¾è¿œä¸€ç‚¹","æ…¢æ…¢æ¥ä¹Ÿæ²¡å…³ç³»","ä»Šå¤©è¯·æ¸©æŸ”å¯¹è‡ªå·±","å…ˆå®Œæˆä¸€ä»¶å°äº‹","æŠŠå¿ƒå®‰æ”¾å¥½","å‹‡æ•¢ï¼Œä½†ä¸é€å¼º","ç›¸ä¿¡æ­¥ä¼çš„åŠ›é‡","æŠŠå¤±è´¥å½“ä½œå›é¦ˆ","è¯•ç€å¾®ç¬‘ä¸€ä¸‹","æ¥çº³ä¸ç¡®å®š","å…è®¸è‡ªå·±ä¼‘æ¯","å…ˆå‘¼å¸ï¼Œå†å‡ºå‘","åˆ«å¿˜äº†è¡¥æ°´","æŠŠæƒ…ç»ªè¯´å‡ºæ¥","åšæŒä½ è®¤åŒçš„èŠ‚å¥","å»æ•£æ­¥äº”åˆ†é’Ÿ","å†™ä¸‹ä½ æ„Ÿè°¢çš„ä¸‰ä»¶äº‹","ä½ å€¼å¾—è¢«å–„å¾…","ä»Šå¤©çš„ä½ ï¼Œå·²è¶³å¤Ÿå¥½"],
      answer_B: ["æ˜å¤©ä¼šæ›´æ¸…æ™°","ç­”æ¡ˆä¼šåœ¨è·¯ä¸Šå‡ºç°","åŠªåŠ›ä¸ä¸€å®šç«‹åˆ»æœ‰æ•ˆ","å€¼å¾—çš„äº‹éƒ½éœ€è¦æ—¶é—´","æ”¾ä¸‹å®Œç¾ä¸»ä¹‰","æŠŠç„¦ç‚¹æ”¾åœ¨å¯è¡Œä¸€æ­¥","å…ˆåšèƒ½åšçš„","ä½ å¯ä»¥æ±‚åŠ©","ç”¨å¥½å¥‡æ›¿ä»£ææƒ§","æŠŠæ ‡å‡†è°ƒæ•´åˆ°å¯è¾¾","è¯·ç›¸ä¿¡è‡ªå·±çš„æ¢å¤åŠ›","æŠŠæ³¨æ„åŠ›å›åˆ°å½“ä¸‹","æŠŠç›®å…‰ä»ç»“æœç§»å¼€","è®©èº«ä½“å‘Šè¯‰ä½ ç•Œçº¿","æŠŠå¿™ç¢Œå˜æˆä¸“æ³¨","ç»ƒä¹ è¯´ä¸"],
      answer_C: ["ä»Šå¤©å·²ç»è¶³å¤ŸåŠªåŠ›ï¼Œæœªæ¥æ‰æœ€ç´§è¦ã€‚","æ­¤åˆ»çš„å®‰å®šï¼Œæ¯”ä»€ä¹ˆéƒ½çè´µã€‚","ä¿æŒå–„è‰¯ä¸ç•Œçº¿ï¼Œä¸¤è€…éƒ½è¦ã€‚","ä½ ä¸æ˜¯ä¸€ä¸ªäººï¼ŒçœŸçš„ã€‚","æ”¾è¿‡è‡ªå·±ä¸€æ¬¡è¯•è¯•ã€‚","å¿ƒè½´ç¨³äº†ï¼Œè·¯å°±ä¸æ™ƒäº†ã€‚","æŠŠåŠ›é‡ç•™ç»™é‡è¦çš„äººä¸äº‹ã€‚","æ„¿ä½ åœ¨é‡è¦å¤„æ¸…é†’ï¼Œåœ¨ç»†ç¢å¤„æŸ”è½¯ã€‚","å°‘æ¯”è¾ƒï¼Œå¤šè¡ŒåŠ¨ã€‚","æ…¢ï¼Œä½†åšå®šã€‚"],
      answer_tags: ["#ä¸“æ³¨","#è¡¥æ°´","#å‘¼å¸","#æ”¾æ¾","#è¡Œä¸€å°æ­¥","#ç•Œçº¿","#è€å¿ƒ","#æ„Ÿè°¢","#ç¡çœ ","#æ¸©æŸ”","#ç›¸ä¿¡","#æ•´ç†"],
    },
    'en': {
      ui_temp: 'Temp', ui_daily_reset: 'Daily Reset', ui_lang: 'Language', lang_symbol: 'En',
      btn_answer: "Today's Answer", btn_answer_done: "Answered", btn_draw_equip: 'Draw Gear', btn_draw_done: 'Drawn Today', btn_gear: 'Gear', btn_close: 'Close', btn_pet: 'Pet', btn_backpack: 'Backpack', btn_prev_page: 'Prev', btn_next_page: 'Next', btn_buy: 'Buy', btn_read: 'Read', btn_name: 'Name', btn_save: 'Save',
      gear_title: 'Gear', gear_subtitle: '(Click to toggle)', btn_equip: 'Equip', btn_unequip: 'Unequip',
      pet_title: 'Pet', pet_subtitle: '(Click to summon/hide)', btn_summon: 'Summon', btn_unsummon: 'Hide',
      backpack_title: 'Backpack', backpack_subtitle: '(Click to read purchased books)', backpack_empty: 'Your backpack is empty.',
      shop_title: 'Bookstore', shop_subtitle: '(Buy some wisdom from me!)', btn_owned: 'Owned',
      name_title: 'Change Name',
      type_head: 'Head', type_eyes: 'Eyes', type_body: 'Body', type_legs: 'Legs',
      hint_welcome: 'Explore your little space!',
      hint_sit: 'You are sitting... Press any arrow key to leave.',
      hint_sleep: 'You are resting... Press any arrow key to get up.',
      hint_read: 'You are reading... Press any arrow key to stop.',
      hint_new_item: 'You got a new item: <b>{itemName}</b>!',
      hint_all_items: 'Congratulations! You have collected all items!',
      hint_buy_book: 'You spent {price} gold on "{bookName}".',
      hint_no_gold: 'Not enough gold!',
      answer_title: "Today's Answer",
      answer_A: ["You are on your way.", "Look at the bigger picture.", "It's okay to go slow.", "Be gentle with yourself today.", "Finish one small thing first.", "Settle your heart.", "Be brave, but not reckless.", "Trust the power of your steps.", "Treat failure as feedback.", "Try to smile.", "Embrace uncertainty.", "Allow yourself to rest.", "Breathe first, then set off.", "Don't forget to hydrate.", "Speak your emotions.", "Stick to a rhythm you approve of.", "Go for a five-minute walk.", "Write down three things you are grateful for.", "You deserve to be treated well.", "You are good enough for today."],
      answer_B: ["Tomorrow will be clearer.", "The answer will appear on the way.", "Hard work doesn't always pay off immediately.", "Things worth doing take time.", "Let go of perfectionism.", "Focus on the next feasible step.", "Do what you can first.", "You can ask for help.", "Replace fear with curiosity.", "Adjust your standards to be achievable.", "Trust in your resilience.", "Bring your attention to the present.", "Shift your focus away from the outcome.", "Let your body tell you your limits.", "Turn busyness into focus.", "Practice saying no."],
      answer_C: ["You've worked hard enough today, the future is what matters.", "The peace of this moment is priceless.", "Maintain both kindness and boundaries.", "You are not alone, really.", "Try letting yourself off the hook for once.", "When your core is stable, the path won't sway.", "Save your energy for important people and things.", "May you be clear-headed in what matters, and gentle in the small things.", "Compare less, act more.", "Slow, but steady."],
      answer_tags: ["#Focus", "#Hydrate", "#Breathe", "#Relax", "#SmallStep", "#Boundaries", "#Patience", "#Gratitude", "#Sleep", "#Gentle", "#Believe", "#Organize"],
    },
    'ja': {
      ui_temp: 'æ°—æ¸©', ui_daily_reset: 'æ¯æ—¥ãƒªã‚»ãƒƒãƒˆ', ui_lang: 'è¨€èª', lang_symbol: 'æ—¥',
      btn_answer: 'ä»Šæ—¥ã®ç­”ãˆ', btn_answer_done: 'å›ç­”æ¸ˆã¿', btn_draw_equip: 'è£…å‚™ã‚¬ãƒãƒ£', btn_draw_done: 'æœ¬æ—¥æŠ½é¸æ¸ˆã¿', btn_gear: 'è£…å‚™', btn_close: 'é–‰ã˜ã‚‹', btn_pet: 'ãƒšãƒƒãƒˆ', btn_backpack: 'ãƒãƒƒã‚°', btn_prev_page: 'å‰ã¸', btn_next_page: 'æ¬¡ã¸', btn_buy: 'è³¼å…¥', btn_read: 'èª­ã‚€', btn_name: 'åå‰', btn_save: 'ä¿å­˜',
      gear_title: 'è£…å‚™', gear_subtitle: 'ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ç€è„±ï¼‰', btn_equip: 'è£…å‚™', btn_unequip: 'å¤–ã™',
      pet_title: 'ãƒšãƒƒãƒˆ', pet_subtitle: 'ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å¬å–š/éš ã™ï¼‰', btn_summon: 'å¬å–š', btn_unsummon: 'éš ã™',
      backpack_title: 'ãƒãƒƒã‚°', backpack_subtitle: 'ï¼ˆè³¼å…¥ã—ãŸæœ¬ã‚’èª­ã‚€ï¼‰', backpack_empty: 'ãƒãƒƒã‚°ã¯ç©ºã§ã™ã€‚',
      shop_title: 'æ›¸åº—', shop_subtitle: 'ï¼ˆç§ã‹ã‚‰çŸ¥æµã‚’è²·ã„ã¾ã›ã‚“ã‹ï¼Ÿï¼‰', btn_owned: 'æ‰€æœ‰æ¸ˆã¿',
      name_title: 'åå‰ã‚’å¤‰æ›´',
      type_head: 'é ­', type_eyes: 'ç›®', type_body: 'ä½“', type_legs: 'è„š',
      hint_welcome: 'ã‚ãªãŸã®å°ã•ãªç©ºé–“ã‚’æ¢æ¤œã—ã‚ˆã†ï¼',
      hint_sit: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã«åº§ã£ã¦ã„ã¾ã™... çŸ¢å°ã‚­ãƒ¼ã§é›¢ã‚Œã¾ã™ã€‚',
      hint_sleep: 'ãƒ™ãƒƒãƒ‰ã§ä¼‘ã‚“ã§ã„ã¾ã™... çŸ¢å°ã‚­ãƒ¼ã§èµ·ãã¾ã™ã€‚',
      hint_read: 'æœ¬ã‚’èª­ã‚“ã§ã„ã¾ã™... çŸ¢å°ã‚­ãƒ¼ã§æ­¢ã‚ã¾ã™ã€‚',
      hint_new_item: 'æ–°ã—ã„è£…å‚™ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼š<b>{itemName}</b>ï¼',
      hint_all_items: 'ãŠã‚ã§ã¨ã†ï¼ã™ã¹ã¦ã®è£…å‚™ã‚’é›†ã‚ã¾ã—ãŸï¼',
      hint_buy_book: '{price}ã‚´ãƒ¼ãƒ«ãƒ‰ã§ã€Œ{bookName}ã€ã‚’è³¼å…¥ã—ã¾ã—ãŸã€‚',
      hint_no_gold: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼',
      answer_title: 'ä»Šæ—¥ã®ç­”ãˆ',
      answer_A: ["ã‚ãªãŸã¯ã‚‚ã†é“ã‚’é€²ã‚“ã§ã„ã¾ã™ã€‚", "è¦–é‡ã‚’åºƒãæŒã¡ã¾ã—ã‚‡ã†ã€‚", "ã‚†ã£ãã‚Šã§å¤§ä¸ˆå¤«ã§ã™ã€‚", "ä»Šæ—¥ã¯è‡ªåˆ†ã«å„ªã—ãã€‚", "ã¾ãšå°ã•ãªã“ã¨ã‚’ä¸€ã¤çµ‚ã‚ã‚‰ã›ã¦ã€‚", "å¿ƒã‚’è½ã¡ç€ã‹ã›ã¦ã€‚", "å‹‡æ•¢ã«ã€ã§ã‚‚ç„¡è¬€ã«ãªã‚‰ãšã€‚", "ä¸€æ­©ã®åŠ›ã‚’ä¿¡ã˜ã¦ã€‚", "å¤±æ•—ã‚’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨æ‰ãˆã¦ã€‚", "å°‘ã—å¾®ç¬‘ã‚“ã§ã¿ã¦ã€‚", "ä¸ç¢ºã‹ã•ã‚’å—ã‘å…¥ã‚Œã¦ã€‚", "ä¼‘ã‚€ã“ã¨ã‚’è‡ªåˆ†ã«è¨±ã—ã¦ã€‚", "ã¾ãšæ·±å‘¼å¸ã€ãã‚Œã‹ã‚‰å‡ºç™ºã€‚", "æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«ã€‚", "æ„Ÿæƒ…ã‚’è¨€è‘‰ã«ã—ã¦ã€‚", "è‡ªåˆ†ãŒç´å¾—ã§ãã‚‹ãƒªã‚ºãƒ ã‚’ä¿ã£ã¦ã€‚", "5åˆ†é–“æ•£æ­©ã«è¡Œãã¾ã—ã‚‡ã†ã€‚", "æ„Ÿè¬ã™ã‚‹ã“ã¨ã‚’3ã¤æ›¸ãå‡ºã—ã¦ã€‚", "ã‚ãªãŸã¯å„ªã—ãã•ã‚Œã‚‹ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚", "ä»Šæ—¥ã®ã‚ãªãŸã¯ã€ãã‚Œã§ååˆ†ã§ã™ã€‚"],
      answer_B: ["æ˜æ—¥ã¯ã‚‚ã£ã¨ã¯ã£ãã‚Šã™ã‚‹ã§ã—ã‚‡ã†ã€‚", "ç­”ãˆã¯é“ä¸­ã§è¦‹ã¤ã‹ã‚Šã¾ã™ã€‚", "åŠªåŠ›ãŒã™ãã«å ±ã‚ã‚Œã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚", "ä¾¡å€¤ã‚ã‚‹ã“ã¨ã«ã¯æ™‚é–“ãŒå¿…è¦ã§ã™ã€‚", "å®Œç’§ä¸»ç¾©ã‚’æ‰‹æ”¾ã—ã¦ã€‚", "å®Ÿè¡Œå¯èƒ½ãªä¸€æ­©ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã€‚", "ã§ãã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ã€‚", "åŠ©ã‘ã‚’æ±‚ã‚ã¦ã‚‚ã„ã„ã®ã§ã™ã€‚", "æã‚Œã‚’å¥½å¥‡å¿ƒã«ç½®ãæ›ãˆã¦ã€‚", "åŸºæº–ã‚’é”æˆå¯èƒ½ãªã‚‚ã®ã«èª¿æ•´ã—ã¦ã€‚", "è‡ªåˆ†ã®å›å¾©åŠ›ã‚’ä¿¡ã˜ã¦ã€‚", "ã€Œä»Šã€ã«æ³¨æ„ã‚’å‘ã‘ã¦ã€‚", "çµæœã‹ã‚‰ç›®ã‚’é›¢ã—ã¦ã€‚", "ä½“ã¨å¿ƒã«å¢ƒç•Œç·šã‚’æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚", "å¿™ã—ã•ã‚’é›†ä¸­åŠ›ã«å¤‰ãˆã¦ã€‚", "ã€Œã„ã„ãˆã€ã¨è¨€ã†ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚"],
      answer_C: ["ä»Šæ—¥ã¯ã‚‚ã†ååˆ†é ‘å¼µã£ãŸã€æœªæ¥ãŒæœ€ã‚‚é‡è¦ã§ã™ã€‚", "ã“ã®ç¬é–“ã®å®‰ã‚‰ãã¯ä½•ã‚ˆã‚Šã‚‚è²´é‡ã§ã™ã€‚", "å„ªã—ã•ã¨å¢ƒç•Œç·šã€ä¸¡æ–¹ã‚’æŒã¡ã¾ã—ã‚‡ã†ã€‚", "ã‚ãªãŸã¯ä¸€äººã˜ã‚ƒãªã„ã€æœ¬å½“ã«ã€‚", "ä¸€åº¦è‡ªåˆ†ã‚’è¨±ã—ã¦ã¿ã¦ã¯ã€‚", "å¿ƒã®è»¸ãŒå®‰å®šã™ã‚Œã°ã€é“ã¯æºã‚‹ãã¾ã›ã‚“ã€‚", "å¤§åˆ‡ãªäººã‚„ã“ã¨ã®ãŸã‚ã«åŠ›ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚", "é‡è¦ãªã“ã¨ã«ã¯ã¯ã£ãã‚Šã¨ã€äº›ç´°ãªã“ã¨ã«ã¯æŸ”ã‚‰ã‹ãã‚ã‚Šã¾ã™ã‚ˆã†ã«ã€‚", "æ¯”ã¹ã‚‹ã“ã¨ã‚’æ¸›ã‚‰ã—ã€è¡Œå‹•ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚", "ã‚†ã£ãã‚Šã€ã§ã‚‚ç€å®Ÿã«ã€‚"],
      answer_tags: ["#é›†ä¸­", "#æ°´åˆ†è£œçµ¦", "#å‘¼å¸", "#ãƒªãƒ©ãƒƒã‚¯ã‚¹", "#å°ã•ãªä¸€æ­©", "#å¢ƒç•Œç·š", "#å¿è€", "#æ„Ÿè¬", "#ç¡çœ ", "#å„ªã—ã•", "#ä¿¡ã˜ã‚‹", "#æ•´ç†"],
    }
  };
  const LANG_CYCLE = ['zh-TW', 'zh-CN', 'en', 'ja'];
  let currentLang = 'zh-TW';

  function t(key, params = {}) {
      if (!key) return '';
      const langPack = LANG_STRINGS[currentLang] || LANG_STRINGS['zh-TW'];
      let str = langPack[key] || key;
      if (str === key && BOOK_CONTENT[currentLang] && BOOK_CONTENT[currentLang][key]) {
        str = BOOK_CONTENT[currentLang][key];
      }
      for (const p in params) {
          str = str.replace(`{${p}}`, params[p]);
      }
      return str;
  }
 
  function updateUIText() {
    document.querySelectorAll('[data-lang]').forEach(el => {
      const key = el.dataset.lang;
      if (! ( (el.id === 'answerBtn' || el.id === 'drawEquipBtn') && el.disabled) ) {
         el.textContent = t(key);
      }
    });
    $('#langDisplay').textContent = t('lang_symbol');
    updateDailyStatus();
    renderAllSheets();
  }

  function setLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang.startsWith('zh') ? lang : lang.split('-')[0];
    updateUIText();
    saveState();
  }

  /* =============================
     éŠæˆ²è³‡æ–™
  ============================= */
  const W = map.width, H = map.height;
 
  const SCENES = {
      room: {
          BED: { id: 'BED', x: 20, y: 30, w: 32, h: 20 },
          TABLE: { id: 'TABLE', x: W - 60, y: 80, w: 40, h: 16 },
          CHAIR: { id: 'CHAIR', x: W - 52, y: 100, w: 10, h: 10 },
          DOOR: { id: 'DOOR_TO_LIB', x: W/2 - 10, y: 0, w: 20, h: 10 }
      },
      library: {
          LIBRARIAN: { id: 'LIBRARIAN', x: 40, y: 50, w: 8, h: 16 },
          LIBRARIAN_INTERACTION_ZONE: { id: 'LIBRARIAN_ZONE', x: 38, y: 48, w: 12, h: 20 },
          DOOR: { id: 'DOOR_TO_ROOM', x: W/2 - 10, y: H - 10, w: 20, h: 10 },
          BOOKSHELF: { id: 'BOOKSHELF', x: 130, y: 20, w: 80, h: 110 }
      }
  };

  const player = {
    x: W/2, y: H/2, speed: 1.2, dir: 'down', state: 'idle', scene: 'room',
    name: 'ç©å®¶',
    lastInteractionObject: null,
    interactionCooldown: 0,
    sceneTransitionCooldown: 0,
    equip:{ head: null, eyes: null, body: null, legs: null },
    unlockedItems: new Set(['sunglasses', 'suit', 'cap_white', 'shorts_red']),
    inventory: new Set(), 
    gold: 10,
    movedSinceLastSave: false
  };

  const pet = {
      x: W / 2 + 20, y: H / 2, dir: 'left', state: 'wandering',
      state_timer: 120, visible: false,
      love_timer: 0,
      gold_find_timer: Math.random() * 1200 + 1200,
  };
 
  const ALL_EQUIPMENT = [
    {id:'sunglasses', nameKey:'item_sunglasses_name', descKey:'item_sunglasses_desc', type:'eyes'},
    {id:'suit', nameKey:'item_suit_name', descKey:'item_suit_desc', type:'body'},
    {id:'cap_white', nameKey:'item_cap_white_name', descKey:'item_cap_white_desc', type:'head'},
    {id:'shorts_red', nameKey:'item_shorts_red_name', descKey:'item_shorts_red_desc', type:'legs'},
    {id:'cap_red', nameKey:'item_cap_red_name', descKey:'item_cap_red_desc', type:'head'},
    {id:'cap_blue', nameKey:'item_cap_blue_name', descKey:'item_cap_blue_desc', type:'head'},
    {id:'glasses_round', nameKey:'item_glasses_round_name', descKey:'item_glasses_round_desc', type:'eyes'},
    {id:'glasses_square', nameKey:'item_glasses_square_name', descKey:'item_glasses_square_desc', type:'eyes'},
    {id:'shirt_tee', nameKey:'item_shirt_tee_name', descKey:'item_shirt_tee_desc', type:'body'},
    {id:'shirt_jacket', nameKey:'item_shirt_jacket_name', descKey:'item_shirt_jacket_desc', type:'body'},
    {id:'shirt_hoodie', nameKey:'item_shirt_hoodie_name', descKey:'item_shirt_hoodie_desc', type:'body'},
    {id:'pants_jeans', nameKey:'item_pants_jeans_name', descKey:'item_pants_jeans_desc', type:'legs'},
    {id:'pants_track', nameKey:'item_pants_track_name', descKey:'item_pants_track_desc', type:'legs'},
    {id:'pants_khaki', nameKey:'item_pants_khaki_name', descKey:'item_pants_khaki_desc', type:'legs'},
    {id:'cape_starlight', nameKey:'item_cape_starlight_name', descKey:'item_cape_starlight_desc', type:'body'},
    {id:'crown_royal', nameKey:'item_crown_royal_name', descKey:'item_crown_royal_desc', type:'head'},
    {id:'boots_rocket', nameKey:'item_boots_rocket_name', descKey:'item_boots_rocket_desc', type:'legs'},
  ];
  const ALL_PETS = [{id: 'cat_blackwhite', nameKey: 'pet_cat_bw_name'}];
 
  const additionalTranslations = {
    'zh-TW': {
        item_sunglasses_name: 'å¤ªé™½çœ¼é¡', item_sunglasses_desc: 'ä¸€å‰¯å¾ˆé…·çš„é…ä»¶ã€‚',
        item_suit_name: 'è¥¿è£', item_suit_desc: 'çœ‹èµ·ä¾†å¾ˆå°ˆæ¥­ã€‚',
        item_cap_white_name: 'ç™½è‰²é´¨èˆŒå¸½', item_cap_white_desc: 'ç¶“å…¸ç°¡æ½”çš„é¢¨æ ¼ã€‚',
        item_shorts_red_name: 'ç´…è‰²çŸ­è¤²', item_shorts_red_desc: 'å……æ»¿æ´»åŠ›çš„é¸æ“‡ã€‚',
        item_cap_red_name: 'ç´…è‰²é´¨èˆŒå¸½', item_cap_red_desc: 'å¼•äººæ³¨ç›®çš„ç´…è‰²å¸½å­ã€‚',
        item_cap_blue_name: 'è—è‰²é´¨èˆŒå¸½', item_cap_blue_desc: 'å†·éœæ²‰ç©©çš„è—è‰²ã€‚',
        item_glasses_round_name: 'åœ“æ¡†çœ¼é¡', item_glasses_round_desc: 'å¸¶é»å¾©å¤çš„æ–‡é’æ„Ÿã€‚',
        item_glasses_square_name: 'æ–¹æ¡†çœ¼é¡', item_glasses_square_desc: 'ä¿è½çš„ç¾ä»£é¢¨æ ¼ã€‚',
        item_shirt_tee_name: 'ç™½è‰²Tæ¤', item_shirt_tee_desc: 'ç™¾æ­çš„åŸºæœ¬æ¬¾ã€‚',
        item_shirt_jacket_name: 'å¤¾å…‹', item_shirt_jacket_desc: 'é©åˆå¾®æ¶¼çš„å¤©æ°£ã€‚',
        item_shirt_hoodie_name: 'å¸½T', item_shirt_hoodie_desc: 'èˆ’é©ä¼‘é–’çš„ç©¿æ­ã€‚',
        item_pants_jeans_name: 'ç‰›ä»”è¤²', item_pants_jeans_desc: 'æ°¸ä¸é€€æµè¡Œçš„ç¶“å…¸ã€‚',
        item_pants_track_name: 'é‹å‹•è¤²', item_pants_track_desc: 'æ–¹ä¾¿æ´»å‹•çš„è¤²å­ã€‚',
        item_pants_khaki_name: 'å¡å…¶è¤²', item_pants_khaki_desc: 'è¼•é¬†çš„ä¼‘é–’é¢¨æ ¼ã€‚',
        item_cape_starlight_name: 'æ˜Ÿå…‰æ–—ç¯·', item_cape_starlight_desc: 'é–ƒçˆè‘—å®‡å®™çš„å…‰èŠ’ã€‚',
        item_crown_royal_name: 'çš‡å®¶ç‹å† ', item_crown_royal_desc: 'å°Šè²´çš„è±¡å¾µã€‚',
        item_boots_rocket_name: 'ç«ç®­é´', item_boots_rocket_desc: 'æ„Ÿè¦ºèƒ½é£›èµ·ä¾†ï¼',
        pet_cat_bw_name: 'é»‘ç™½è²“',
        book_compass_name: 'æ˜Ÿè¾°è¿½é€è€…çš„ç¾…ç›¤',
        book_garden_name: 'å¯§éœçš„å¿ƒéˆèŠ±åœ’',
        book_emotions_name: 'æƒ…ç·’æ•´ç†è¡“',
        book_mindfulness_name: 'ç•¶ä¸‹çš„åŠ›é‡',
    },
    'zh-CN': {
        item_sunglasses_name: 'å¤ªé˜³çœ¼é•œ', item_sunglasses_desc: 'ä¸€å‰¯å¾ˆé…·çš„é…ä»¶ã€‚',
        item_suit_name: 'è¥¿è£…', item_suit_desc: 'çœ‹èµ·æ¥å¾ˆä¸“ä¸šã€‚',
        item_cap_white_name: 'ç™½è‰²é¸­èˆŒå¸½', item_cap_white_desc: 'ç»å…¸ç®€æ´çš„é£æ ¼ã€‚',
        item_shorts_red_name: 'çº¢è‰²çŸ­è£¤', item_shorts_red_desc: 'å……æ»¡æ´»åŠ›çš„é€‰æ‹©ã€‚',
        item_cap_red_name: 'çº¢è‰²é¸­èˆŒå¸½', item_cap_red_desc: 'å¼•äººæ³¨ç›®çš„çº¢è‰²å¸½å­ã€‚',
        item_cap_blue_name: 'è“è‰²é¸­èˆŒå¸½', item_cap_blue_desc: 'å†·é™æ²‰ç¨³çš„è“è‰²ã€‚',
        item_glasses_round_name: 'åœ†æ¡†çœ¼é•œ', item_glasses_round_desc: 'å¸¦ç‚¹å¤å¤çš„æ–‡é’æ„Ÿã€‚',
        item_glasses_square_name: 'æ–¹æ¡†çœ¼é•œ', item_glasses_square_desc: 'ä¿è½çš„ç°ä»£é£æ ¼ã€‚',
        item_shirt_tee_name: 'ç™½è‰²Tæ¤', item_shirt_tee_desc: 'ç™¾æ­çš„åŸºæœ¬æ¬¾ã€‚',
        item_shirt_jacket_name: 'å¤¹å…‹', item_shirt_jacket_desc: 'é€‚åˆå¾®å‡‰çš„å¤©æ°”ã€‚',
        item_shirt_hoodie_name: 'å¸½è¡«', item_shirt_hoodie_desc: 'èˆ’é€‚ä¼‘é—²çš„ç©¿æ­ã€‚',
        item_pants_jeans_name: 'ç‰›ä»”è£¤', item_pants_jeans_desc: 'æ°¸ä¸é€€æµè¡Œçš„ç»å…¸ã€‚',
        item_pants_track_name: 'è¿åŠ¨è£¤', item_pants_track_desc: 'æ–¹ä¾¿æ´»åŠ¨çš„è£¤å­ã€‚',
        item_pants_khaki_name: 'å¡å…¶è£¤', item_pants_khaki_desc: 'è½»æ¾çš„ä¼‘é—²é£æ ¼ã€‚',
        item_cape_starlight_name: 'æ˜Ÿå…‰æ–—ç¯·', item_cape_starlight_desc: 'é—ªçƒç€å®‡å®™çš„å…‰èŠ’ã€‚',
        item_crown_royal_name: 'çš‡å®¶ç‹å† ', item_crown_royal_desc: 'å°Šè´µçš„è±¡å¾ã€‚',
        item_boots_rocket_name: 'ç«ç®­é´', item_boots_rocket_desc: 'æ„Ÿè§‰èƒ½é£èµ·æ¥ï¼',
        pet_cat_bw_name: 'é»‘ç™½çŒ«',
        book_compass_name: 'æ˜Ÿè¾°è¿½é€è€…çš„ç½—ç›˜',
        book_garden_name: 'å®é™çš„å¿ƒçµèŠ±å›­',
        book_emotions_name: 'æƒ…ç»ªæ•´ç†æœ¯',
        book_mindfulness_name: 'å½“ä¸‹çš„åŠ›é‡',
    },
    'en': {
        item_sunglasses_name: 'Sunglasses', item_sunglasses_desc: 'A pair of cool shades.',
        item_suit_name: 'Suit', item_suit_desc: 'Looks very professional.',
        item_cap_white_name: 'White Cap', item_cap_white_desc: 'A classic and clean style.',
        item_shorts_red_name: 'Red Shorts', item_shorts_red_desc: 'A vibrant choice.',
        item_cap_red_name: 'Red Cap', item_cap_red_desc: 'An eye-catching red hat.',
        item_cap_blue_name: 'Blue Cap', item_cap_blue_desc: 'A calm and steady blue.',
        item_glasses_round_name: 'Round Glasses', item_glasses_round_desc: 'A touch of retro, literary feel.',
        item_glasses_square_name: 'Square Glasses', item_glasses_square_desc: 'A sharp, modern style.',
        item_shirt_tee_name: 'White T-shirt', item_shirt_tee_desc: 'A versatile basic item.',
        item_shirt_jacket_name: 'Jacket', item_shirt_jacket_desc: 'Suitable for cool weather.',
        item_shirt_hoodie_name: 'Hoodie', item_shirt_hoodie_desc: 'Comfortable and casual wear.',
        item_pants_jeans_name: 'Jeans', item_pants_jeans_desc: 'A timeless classic.',
        item_pants_track_name: 'Track Pants', item_pants_track_desc: 'Pants for easy movement.',
        item_pants_khaki_name: 'Khaki Pants', item_pants_khaki_desc: 'A relaxed, casual style.',
        item_cape_starlight_name: 'Starlight Cape', item_cape_starlight_desc: 'Shimmers with the light of the cosmos.',
        item_crown_royal_name: 'Royal Crown', item_crown_royal_desc: 'A symbol of nobility.',
        item_boots_rocket_name: 'Rocket Boots', item_boots_rocket_desc: 'Feels like you could fly!',
        pet_cat_bw_name: 'Black & White Cat',
        book_compass_name: 'The Star Chaser\'s Compass',
        book_garden_name: 'The Serene Mind Garden',
        book_emotions_name: 'The Art of Emotional Regulation',
        book_mindfulness_name: 'The Power of Now',
    },
    'ja': {
        item_sunglasses_name: 'ã‚µãƒ³ã‚°ãƒ©ã‚¹', item_sunglasses_desc: 'ã‚¯ãƒ¼ãƒ«ãªã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã€‚',
        item_suit_name: 'ã‚¹ãƒ¼ãƒ„', item_suit_desc: 'ã¨ã¦ã‚‚ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã«è¦‹ãˆã‚‹ã€‚',
        item_cap_white_name: 'ç™½ã„ã‚­ãƒ£ãƒƒãƒ—', item_cap_white_desc: 'ã‚¯ãƒ©ã‚·ãƒƒã‚¯ã§ã‚¯ãƒªãƒ¼ãƒ³ãªã‚¹ã‚¿ã‚¤ãƒ«ã€‚',
        item_shorts_red_name: 'èµ¤ã„ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ãƒ³ãƒ„', item_shorts_red_desc: 'æ´»åŠ›ã«æº€ã¡ãŸé¸æŠã€‚',
        item_cap_red_name: 'èµ¤ã„ã‚­ãƒ£ãƒƒãƒ—', item_cap_red_desc: 'äººç›®ã‚’å¼•ãèµ¤ã„å¸½å­ã€‚',
        item_cap_blue_name: 'é’ã„ã‚­ãƒ£ãƒƒãƒ—', item_cap_blue_desc: 'è½ã¡ç€ã„ãŸé’è‰²ã€‚',
        item_glasses_round_name: 'ä¸¸ãƒ¡ã‚¬ãƒ', item_glasses_round_desc: 'ãƒ¬ãƒˆãƒ­ã§æ–‡åŒ–çš„ãªé›°å›²æ°—ã€‚',
        item_glasses_square_name: 'å››è§’ã„ãƒ¡ã‚¬ãƒ', item_glasses_square_desc: 'ã‚·ãƒ£ãƒ¼ãƒ—ã§ãƒ¢ãƒ€ãƒ³ãªã‚¹ã‚¿ã‚¤ãƒ«ã€‚',
        item_shirt_tee_name: 'ç™½ã„Tã‚·ãƒ£ãƒ„', item_shirt_tee_desc: 'ä¸‡èƒ½ãªåŸºæœ¬ã‚¢ã‚¤ãƒ†ãƒ ã€‚',
        item_shirt_jacket_name: 'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ', item_shirt_jacket_desc: 'æ¶¼ã—ã„å¤©æ°—ã«ã´ã£ãŸã‚Šã€‚',
        item_shirt_hoodie_name: 'ãƒ‘ãƒ¼ã‚«ãƒ¼', item_shirt_hoodie_desc: 'å¿«é©ã§ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªæœè£…ã€‚',
        item_pants_jeans_name: 'ã‚¸ãƒ¼ãƒ³ã‚º', item_pants_jeans_desc: 'æ™‚ä»£ã‚’è¶…ãˆã¦æ„›ã•ã‚Œã‚‹å®šç•ªã€‚',
        item_pants_track_name: 'ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒ³ãƒ„', item_pants_track_desc: 'å‹•ãã‚„ã™ã„ãƒ‘ãƒ³ãƒ„ã€‚',
        item_pants_khaki_name: 'ã‚«ãƒ¼ã‚­ãƒ‘ãƒ³ãƒ„', item_pants_khaki_desc: 'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã€‚',
        item_cape_starlight_name: 'æ˜Ÿå…‰ã®ãƒãƒ³ãƒˆ', item_cape_starlight_desc: 'å®‡å®™ã®å…‰ã§è¼ã„ã¦ã„ã‚‹ã€‚',
        item_crown_royal_name: 'ç‹å®¶ã®å† ', item_crown_royal_desc: 'é«˜è²´ã•ã®è±¡å¾´ã€‚',
        item_boots_rocket_name: 'ãƒ­ã‚±ãƒƒãƒˆãƒ–ãƒ¼ãƒ„', item_boots_rocket_desc: 'é£›ã¹ãã†ãªæ°—ãŒã™ã‚‹ï¼',
        pet_cat_bw_name: 'ç™½é»’çŒ«',
        book_compass_name: 'æ˜Ÿã‚’è¿½ã†è€…ã®ç¾…é‡ç›¤',
        book_garden_name: 'é™å¯‚ãªå¿ƒã®åº­',
        book_emotions_name: 'æ„Ÿæƒ…æ•´ç†ã®è¡“',
        book_mindfulness_name: 'ã€Œä»Šã€ã¨ã„ã†åŠ›',
    }
  };
  Object.keys(additionalTranslations).forEach(lang => {
      Object.assign(LANG_STRINGS[lang], additionalTranslations[lang]);
  });

  /* =============================
     ç¹ªåœ–å‡½å¼
  ============================= */
  const floorPattern = (()=>{
    const c = document.createElement('canvas'); c.width = c.height = 8;
    const g = c.getContext('2d');
    g.fillStyle = '#182048'; g.fillRect(0,0,8,8);
    g.fillStyle = '#1a2550'; g.fillRect(0,0,4,4);
    g.fillStyle = '#141c3f'; g.fillRect(4,4,4,4);
    return ctx.createPattern(c,'repeat');
  })();

  function drawDude(px, py, dir, equip, state){
    const g = ctx;
    const x = Math.round(px), y = Math.round(py);

    if (state === 'sleeping') {
      plotRect(px - 8, py - 4, 16, 8, '#a8b2d1');
      plotRect(px - 10, py - 3, 4, 4, '#3b2d20');
      plotRect(px - 7, py - 2, 2, 2, '#f2d2b6');
      return;
    }
    if (state === 'sitting' || state === 'reading') { py += 2; }
   
    const skin='#f2d2b6', hair='#3b2d20', shoes='#151a30', outline='#0b0e1c';
    const capColors = {cap_white:'#f5f6fa', cap_red:'#e84118', cap_blue:'#3742fa', crown_royal: '#f1c40f'};
   
    let shirtColor = '#3c6fd8', pantsColor = '#2a3558';
    if(equip.body === 'suit') { shirtColor = '#2b3a67'; pantsColor = '#1f2847'; }
    if(equip.body === 'shirt_tee') shirtColor = '#ffffff';
    if(equip.body === 'shirt_jacket') shirtColor = '#4b6584';
    if(equip.body === 'shirt_hoodie') shirtColor = '#d1d8e0';
    if(equip.body === 'cape_starlight') { shirtColor = '#2c3e50'; }
   
    if(equip.legs === 'shorts_red') pantsColor = '#e84118';
    if(equip.legs === 'pants_jeans') pantsColor = '#2c3e50';
    if(equip.legs === 'pants_track') pantsColor = '#778ca3';
    if(equip.legs === 'pants_khaki') pantsColor = '#be9a60';
   
    if(equip.body === 'cape_starlight'){
        plotRect(x-5, y+1, 10, 8, '#4834d4');
        for(let i=0; i<3; i++) plotRect(x-4+i*3, y+2+i, 1, 1, '#f1c40f');
    }

    g.fillStyle = '#00000055'; g.fillRect(x-4, y+8, 8, 2);

    if (dir==='down'){
      if(equip.head){ plotRect(x-4, y-8, 8, 4, capColors[equip.head]||'#fff'); if(equip.head==='crown_royal') { plotRect(x-2, y-9, 1,1,capColors.crown_royal); plotRect(x, y-9, 1,1,capColors.crown_royal); plotRect(x+2, y-9, 1,1,capColors.crown_royal); }} 
      else { plotRect(x-3,y-7,6,2,hair); plotRect(x-4,y-5,8,2,hair); }
      plotRect(x-3,y-3,6,4,skin);
      if(equip.eyes === 'sunglasses') { plotRect(x-3,y-2,6,2,'#0c0f1e'); }
      else if(equip.eyes === 'glasses_round') { plotRect(x-2,y-1,1,1,outline); plotRect(x+1,y-1,1,1,outline); }
      else if(equip.eyes === 'glasses_square') { plotRect(x-4,y-2,3,1,outline); plotRect(x+1,y-2,3,1,outline); }
      else { plotRect(x-2,y-1,1,1,outline); plotRect(x+1,y-1,1,1,outline); }
      plotRect(x-3,y+1,6,4,shirtColor);
      if(equip.body === 'suit'){ plotRect(x-3,y+1,1,4,outline); plotRect(x+2,y+1,1,4,outline); }
      if(state === 'idle'){
          plotRect(x-3,y+5,2,3,pantsColor); plotRect(x+1,y+5,2,3,pantsColor);
          if (equip.legs === 'boots_rocket') { plotRect(x-3,y+8,2,2,'#7f8c8d'); plotRect(x+1,y+8,2,2,'#7f8c8d');} 
          else { plotRect(x-3,y+8,2,1,shoes); plotRect(x+1,y+8,2,1,shoes); }
      }
    } else if (dir==='up'){
      if(equip.head){ plotRect(x-3,y-7,6,6,capColors[equip.head]||'#fff'); }
      else { plotRect(x-3,y-7,6,6,hair); }
      plotRect(x-3,y-1,6,1,skin); plotRect(x-3,y,6,5,shirtColor);
      if(equip.body === 'suit'){ plotRect(x-3,y,1,5,outline); plotRect(x+2,y,1,5,outline); }
      if(state === 'idle'){
        plotRect(x-3,y+5,2,3,pantsColor); plotRect(x+1,y+5,2,3,pantsColor);
        if (equip.legs === 'boots_rocket') { plotRect(x-3,y+8,2,2,'#7f8c8d'); plotRect(x+1,y+8,2,2,'#7f8c8d');} 
        else { plotRect(x-3,y+8,2,1,shoes); plotRect(x+1,y+8,2,1,shoes); }
      }
    } else if (dir==='left' || dir==='right'){
      const flip = dir==='left' ? -1 : 1;
      if(equip.head){ plotRect(x-4, y-8, 8, 4, capColors[equip.head]||'#fff'); if(equip.head !== 'crown_royal') plotRect(x - (dir==='left' ? 4 : -1), y-5, 5*flip, 1, capColors[equip.head]||'#fff');} 
      else { plotRect(x-3*flip,y-7,6*flip,2,hair); plotRect(x-4*flip,y-5,8*flip,2,hair); }
      plotRect(x-3*flip,y-3,6*flip,4,skin);
      if(equip.eyes === 'sunglasses') { plotRect(x-(dir==='left'?3:0), y-2, 3,2, '#0c0f1e'); }
      else if(equip.eyes === 'glasses_square') { plotRect(x-(dir==='left'?3:0), y-2, 3, 1, outline); }
      else if(equip.eyes) { plotRect(x+(dir==='left'?-2:1), y-1,1,1, outline); }
      plotRect(x-3*flip,y+1,6*flip,4,shirtColor);
      if(equip.body === 'suit'){ plotRect(x-(dir==='left'?3:-3),y+1,1,4,outline); }
      if(state === 'idle'){
        plotRect(x-3*flip,y+5,2*flip,3,pantsColor); plotRect(x+(dir==='left'?1:-1),y+5,2,3,pantsColor);
        if (equip.legs === 'boots_rocket') { 
            plotRect(x-3*flip,y+8,2*flip,2,'#7f8c8d'); plotRect(x+(dir==='left'?1:-1),y+8,2,2,'#7f8c8d');
        } else {
            plotRect(x-3*flip,y+8,2*flip,1,shoes); plotRect(x+(dir==='left'?1:-1),y+8,2,1,shoes);
        }
      }
    }
  }

  function plotRect(px,py,w,h,color,alpha=1){
    ctx.globalAlpha = alpha; ctx.fillStyle = color;
    ctx.fillRect(px,py,w,h);
    ctx.globalAlpha = 1;
  }
 
  function drawPet(px, py, dir, state) {
      const x = Math.round(px), y = Math.round(py);
      const bodyWhite = '#f1f2f6', bodyBlack = '#2f3542', collar = '#e84118', eyeColor = '#000';
     
      plotRect(x-4, y-2, 8, 6, bodyWhite); // body
      plotRect(x-2, y-5, 4, 3, bodyWhite); // head
      plotRect(x-3, y-6, 2, 1, bodyBlack); // ears
      plotRect(x+1, y-6, 2, 1, bodyBlack);
      plotRect(x-1, y-4, 1, 1, eyeColor); // eyes
      plotRect(x+1, y-4, 1, 1, eyeColor);
      plotRect(x-2, y-2, 4, 1, collar); // collar
      plotRect(x-5, y, 1, 4, bodyBlack); // tail
      plotRect(x-6, y+3, 1, 1, bodyBlack);
      plotRect(x, y+1, 3, 3, bodyBlack); // patches
      plotRect(x-4, y-1, 2, 2, bodyBlack);
  }

  function drawMap(){
    ctx.fillStyle = floorPattern; ctx.fillRect(0,0,W,H);
    const sunX = W - 25, sunY = 25, sunRadius = 10;
    if (isDay) {
        ctx.fillStyle = '#f9d71c';
        for (let i = 0; i < 8; i++) {
            const angle = (i / 8) * (2 * Math.PI);
            const x1 = sunX + Math.cos(angle) * (sunRadius + 2);
            const y1 = sunY + Math.sin(angle) * (sunRadius + 2);
            const x2 = sunX + Math.cos(angle - 0.1) * (sunRadius + 8);
            const y2 = sunY + Math.sin(angle - 0.1) * (sunRadius + 8);
            const x3 = sunX + Math.cos(angle + 0.1) * (sunRadius + 8);
            const y3 = sunY + Math.sin(angle + 0.1) * (sunRadius + 8);
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x3, y3);
            ctx.closePath();
            ctx.fill();
        }
        ctx.fillStyle = '#ffeaa7'; ctx.beginPath(); ctx.arc(sunX, sunY, sunRadius, 0, Math.PI * 2); ctx.fill();
    } else {
        ctx.fillStyle = '#f1f2f6'; ctx.beginPath(); ctx.arc(W - 22, 22, 10, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
        ctx.beginPath(); ctx.arc(W - 18, 19, 9, 0, Math.PI * 2); ctx.fill();
    }

    if (player.scene === 'room') {
        const { BED, TABLE, CHAIR, DOOR } = SCENES.room;
        ctx.fillStyle = '#634c3a'; ctx.fillRect(TABLE.x, TABLE.y, TABLE.w, TABLE.h);
        ctx.fillStyle = '#4d3a2d'; ctx.fillRect(CHAIR.x, CHAIR.y, CHAIR.w, CHAIR.h);
        ctx.fillStyle = '#3e6a88'; ctx.fillRect(BED.x, BED.y, BED.w, BED.h);
        ctx.fillStyle = '#ffffff'; ctx.fillRect(BED.x + 3, BED.y + 4, 10, 8);
        ctx.fillStyle = '#d1d8e0'; ctx.fillRect(BED.x + 3, BED.y + 4, 10, 1);
        ctx.fillStyle = '#4d3a2d'; ctx.fillRect(DOOR.x, DOOR.y, DOOR.w, DOOR.h);
    } else if (player.scene === 'library') {
        const { LIBRARIAN, DOOR, BOOKSHELF } = SCENES.library;
        drawDude(LIBRARIAN.x, LIBRARIAN.y, 'down', { body: 'suit' }, 'idle');
        
        // Simplified bookshelf drawing
        ctx.fillStyle = '#8c6d53';
        ctx.fillRect(BOOKSHELF.x, BOOKSHELF.y, BOOKSHELF.w, BOOKSHELF.h);
        
        ctx.fillStyle = '#4d3a2d'; ctx.fillRect(DOOR.x, DOOR.y, DOOR.w, DOOR.h);
    }
  }

  function drawEffects() {
    effects.forEach((p, i) => {
      p.y += p.vy; p.x += p.vx; p.life--;
      ctx.globalAlpha = Math.max(0, p.life / p.maxLife);
      ctx.fillStyle = p.color || '#fff';
      ctx.font = `${p.size}px sans-serif`;
      ctx.fillText(p.text, p.x, p.y);
      if (p.life <= 0) effects.splice(i, 1);
    });
    ctx.globalAlpha = 1;

    if (eatingEffect.active) {
      const bubbleW = 24, bubbleH = 18;
      let bubbleX = player.x - bubbleW / 2, bubbleY = player.y - 28;
      if (player.state === 'reading') { bubbleX = player.x; bubbleY = player.y - 20;}

      ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.roundRect(bubbleX, bubbleY, bubbleW, bubbleH, 8);
      ctx.moveTo(bubbleX + bubbleW / 2 - 4, bubbleY + bubbleH); ctx.lineTo(bubbleX + bubbleW / 2, bubbleY + bubbleH + 5); ctx.lineTo(bubbleX + bubbleW / 2 + 4, bubbleY + bubbleH); ctx.fill();
      ctx.font = '14px sans-serif'; ctx.fillText(player.state === 'reading' ? 'ğŸ“–' : 'ğŸœ', bubbleX + 4, bubbleY + 14);
    }
  }

  /* =============================
     éŠæˆ²è¿´åœˆèˆ‡æ§åˆ¶
  ============================= */
  const keys = new Set();
  window.addEventListener('keydown',e=>{ if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ e.preventDefault(); keys.add(e.key); }});
  window.addEventListener('keyup',e=>keys.delete(e.key));

  const hold = {up:false,down:false,left:false,right:false};
  dpad.addEventListener('touchstart',onPad,true);
  dpad.addEventListener('touchend',onPad,true);
  dpad.addEventListener('touchcancel',onPad,true);
  function onPad(e){
    const t = e.target.closest('button'); if (!t) return;
    e.preventDefault(); const dir = t.dataset.dir;
    hold[dir] = (e.type==='touchstart');
  }
 
  function isColliding(a, b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

  function checkInteractions(){
      if (player.state !== 'idle' || player.interactionCooldown > 0) return;
      const p_hitbox = {x: player.x-4, y: player.y-8, w: 8, h: 16};
     
      if (player.scene === 'room') {
        const { BED, CHAIR, DOOR } = SCENES.room;
        if (isColliding(p_hitbox, CHAIR) && player.lastInteractionObject !== CHAIR) {
            player.state = 'sitting'; player.x = CHAIR.x + CHAIR.w / 2; player.y = CHAIR.y; showHint(t('hint_sit'));
            player.lastInteractionObject = CHAIR;
        } else if (isColliding(p_hitbox, BED) && player.lastInteractionObject !== BED) {
            player.state = 'sleeping'; player.x = BED.x + BED.w / 2 - 5; player.y = BED.y + BED.h / 2; showHint(t('hint_sleep'));
            player.lastInteractionObject = BED;
        } else if (isColliding(p_hitbox, DOOR) && player.sceneTransitionCooldown <= 0) {
            player.scene = 'library'; player.x = SCENES.library.DOOR.x + SCENES.library.DOOR.w/2; player.y = SCENES.library.DOOR.y - 16;
            player.sceneTransitionCooldown = 30;
        }
      } else if (player.scene === 'library') {
          const { DOOR, LIBRARIAN, BOOKSHELF, LIBRARIAN_INTERACTION_ZONE } = SCENES.library;
          if (isColliding(p_hitbox, DOOR) && player.sceneTransitionCooldown <= 0) {
              player.scene = 'room'; player.x = SCENES.room.DOOR.x + SCENES.room.DOOR.w/2; 
              player.y = SCENES.room.DOOR.y + 26;
              player.sceneTransitionCooldown = 30;
          } else if (isColliding(p_hitbox, LIBRARIAN_INTERACTION_ZONE) && player.lastInteractionObject !== LIBRARIAN) {
              togglePanel('shopSheet', true);
              player.lastInteractionObject = LIBRARIAN;
          } else if (isColliding(p_hitbox, BOOKSHELF) && player.lastInteractionObject !== BOOKSHELF) {
              player.state = 'reading'; player.x = BOOKSHELF.x - 8; player.y = BOOKSHELF.y + BOOKSHELF.h/2; showHint(t('hint_read'));
              player.lastInteractionObject = BOOKSHELF;
          }
      }
  }

  function updatePet() {
      if (!pet.visible) return;
      pet.state_timer--;
      if (pet.state_timer <= 0) {
          pet.state = Math.random() < 0.7 ? 'wandering' : 'sitting';
          pet.state_timer = Math.random() * 180 + 120;
          const dirs = ['up', 'down', 'left', 'right'];
          pet.dir = dirs[Math.floor(Math.random() * dirs.length)];
      }

      if (pet.state === 'wandering') {
          let dx = 0, dy = 0;
          if (pet.dir === 'left') dx = -1; if (pet.dir === 'right') dx = 1;
          if (pet.dir === 'up') dy = -1; if (pet.dir === 'down') dy = 1;
          pet.x = Math.max(8, Math.min(W-8, pet.x + dx * 0.5));
          pet.y = Math.max(16, Math.min(H-8, pet.y + dy * 0.5));
      }
     
      if(pet.love_timer > 0) {
          pet.love_timer--;
          if (pet.love_timer % 15 === 0) {
              effects.push({ text: 'â¤ï¸', x: pet.x, y: pet.y - 8, vx: 0, vy: -0.1, life: 30, maxLife: 30, size: 10, color: '#e74c3c' });
          }
      }
      
      pet.gold_find_timer--;
      if (pet.gold_find_timer <= 0) {
          player.gold += 2;
          updateDailyStatus();
          effects.push({ text: 'ğŸ’°+2', x: pet.x, y: pet.y - 8, vx: 0, vy: -0.2, life: 60, maxLife: 60, size: 12, color: 'var(--coin)' });
          pet.gold_find_timer = Math.random() * 1200 + 1200;
      }
  }

  function step(){
    if (player.interactionCooldown > 0) player.interactionCooldown--;
    if (player.sceneTransitionCooldown > 0) player.sceneTransitionCooldown--;

    if (player.lastInteractionObject) {
        const p_hitbox = {x: player.x-4, y: player.y-8, w: 8, h: 16};
        
        let effective_hitbox = player.lastInteractionObject;
        if (player.lastInteractionObject.id === 'LIBRARIAN') {
            effective_hitbox = SCENES.library.LIBRARIAN_INTERACTION_ZONE;
        }

        if (!isColliding(p_hitbox, effective_hitbox)) {
            player.lastInteractionObject = null;
        }
    }

    let dx=0, dy=0;
    if (keys.has('ArrowUp')||hold.up) dy=-1; if (keys.has('ArrowDown')||hold.down) dy=1;
    if (keys.has('ArrowLeft')||hold.left) dx=-1; if (keys.has('ArrowRight')||hold.right) dx=1;
   
    if (player.state !== 'idle' && (dx || dy)) {
        const lastState = player.state;
        player.state = 'idle';
        player.interactionCooldown = 15;
        if (lastState === 'sitting') { player.y = SCENES.room.CHAIR.y + SCENES.room.CHAIR.h + 8; player.dir = 'down'; } 
        else if (lastState === 'sleeping') { player.y = SCENES.room.BED.y + SCENES.room.BED.h + 8; player.dir = 'down'; }
        else if (lastState === 'reading') { player.y += 8; player.dir = 'right'; }
    } else if (player.state === 'idle' && (dx || dy)) {
        if(dx !== 0) player.dir = dx > 0 ? 'right' : 'left';
        else if(dy !== 0) player.dir = dy > 0 ? 'down' : 'up';
       
        const len = Math.hypot(dx,dy)||1;
        let nextX = player.x + (dx/len)*player.speed;
        let nextY = player.y + (dy/len)*player.speed;

        if(player.scene === 'library') {
            const npc_hitbox = SCENES.library.LIBRARIAN;
            if (isColliding({x: nextX-4, y: player.y-8, w:8, h:16}, npc_hitbox)) {
                nextX = player.x;
            }
            if (isColliding({x: player.x-4, y: nextY-8, w:8, h:16}, npc_hitbox)) {
                nextY = player.y;
            }
        }
       
        player.x = Math.max(8, Math.min(W-8, nextX));
        player.y = Math.max(16, Math.min(H-8, nextY));
        player.movedSinceLastSave = true;
        checkInteractions();
    }
   
    const p_hitbox = {x: player.x-4, y: player.y-4, w: 8, h: 8};
    const pet_hitbox = {x: pet.x-4, y: pet.y-4, w: 8, h: 8};
    if (pet.visible && player.scene === 'room' && isColliding(p_hitbox, pet_hitbox)) {
        player.x -= (dx||0) * 1.5;
        player.y -= (dy||0) * 1.5;
        pet.state = 'sitting';
        pet.state_timer = 60; 
        pet.love_timer = 60;
    }

    if (player.state === 'sleeping' && Math.random() < 0.05) {
      effects.push({ text: Math.random() < 0.5 ? 'z' : 'Z', x: player.x + 8, y: player.y - 2, vx: Math.random() * 0.2 - 0.1, vy: -0.2, life: 80, maxLife: 80, size: Math.random() * 4 + 8 });
    }
    eatingEffect.timer--;
    if ((player.state === 'sitting' || player.state === 'reading') && eatingEffect.timer <= 0) {
      eatingEffect.active = !eatingEffect.active;
      eatingEffect.timer = eatingEffect.duration;
    } else if (player.state !== 'sitting' && player.state !== 'reading') {
      eatingEffect.active = false;
    }

    if(player.scene === 'room') updatePet();
   
    ctx.imageSmoothingEnabled = false;
    ctx.clearRect(0,0,W,H);
    drawMap();
    if(player.scene === 'room' && pet.visible) drawPet(pet.x, pet.y, pet.dir, pet.state);
    drawDude(player.x, player.y, player.dir, player.equip, player.state);
    
    if (player.name) {
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.font = '10px sans-serif';
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 2;
        ctx.fillText(player.name, player.x, player.y + 16);
        ctx.textAlign = 'left';
        ctx.shadowBlur = 0;
    }
    
    drawEffects();
    requestAnimationFrame(step);
  }

  /* =============================
     ç‹€æ…‹å­˜å–
  ============================= */
  function saveState(){
    try {
      const state = { x: player.x, y: player.y, equip: player.equip, unlockedItems: [...player.unlockedItems], inventory: [...player.inventory], gold: player.gold, scene: player.scene, lang: currentLang, name: player.name };
      localStorage.setItem('book-rpg-state-v6', JSON.stringify(state));
    } catch(e) { console.warn("ç„¡æ³•å„²å­˜ç‹€æ…‹:", e); }
  }

  function loadState(){
    try {
      const savedState = localStorage.getItem('book-rpg-state-v6');
      if (savedState) {
        const state = JSON.parse(savedState);
        if (state.name) player.name = state.name;
        delete state.name;
        Object.assign(player, state);
        player.unlockedItems = new Set(state.unlockedItems);
        player.inventory = new Set(state.inventory);
      }
    } catch(e) { console.warn("ç„¡æ³•è®€å–ç‹€æ…‹:", e); localStorage.removeItem('book-rpg-state-v6'); }
  }

  /* =============================
     æ¯æ—¥åŠŸèƒ½
  ============================= */
  const answerBtn = $('#answerBtn');
  const drawEquipBtn = $('#drawEquipBtn');
  const resetCountdownEl = $('#resetCountdown');

  function todayKey(){
    const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function nextMidnight(){ const d = new Date(); d.setHours(24,0,0,0); return d; }
  function seededRandom(seed) { let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
 
  function updateDailyStatus(){
      const key = todayKey();
      answerBtn.disabled = localStorage.getItem('daily.usedAt') === key;
      answerBtn.textContent = answerBtn.disabled ? t('btn_answer_done') : t('btn_answer');
      drawEquipBtn.disabled = localStorage.getItem('daily.equipDrawnAt') === key;
      drawEquipBtn.textContent = drawEquipBtn.disabled ? t('btn_draw_done') : t('btn_draw_equip');
      $('#goldDisplay').textContent = player.gold;
  }
 
  function updateCountdown(){
    const remain = nextMidnight() - new Date();
    if (remain <= 1000) { 
      localStorage.removeItem('daily.usedAt'); localStorage.removeItem('daily.answerSeed'); localStorage.removeItem('daily.equipDrawnAt');
      setTimeout(updateDailyStatus, 2000); 
    }
    resetCountdownEl.textContent = msToHMS(Math.max(0,remain));
  }

  function msToHMS(ms){
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,'0'); const mm = String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }
  function showHint(text){ msgBox.innerHTML = `<div>${text}</div>`; }

  function pickDailyAnswer(seed) {
      const s1 = t('answer_A')[Math.floor(seededRandom(seed + 1) * t('answer_A').length)]; const s2 = t('answer_B')[Math.floor(seededRandom(seed + 2) * t('answer_B').length)];
      const s3 = t('answer_C')[Math.floor(seededRandom(seed + 3) * t('answer_C').length)]; const t1 = t('answer_tags')[Math.floor(seededRandom(seed + 4) * t('answer_tags').length)];
      const t2 = t('answer_tags')[Math.floor(seededRandom(seed + 5) * t('answer_tags').length)];
      return `${s1} ${s2} ${s3} ${t1} ${t2}`;
  }

  function onAnswerBtnClick(){
      const key = todayKey();
      let seed = localStorage.getItem('daily.answerSeed');
     
      if (localStorage.getItem('daily.usedAt') !== key) {
          localStorage.setItem('daily.usedAt', key);
          seed = String(Date.now() + Math.random());
          localStorage.setItem('daily.answerSeed', seed);
          player.gold += 2;
          saveState();
      }
     
      const s = pickDailyAnswer(Number(seed));
      showHint(`<b>${t('answer_title')}ï¼š</b>${s}`);
      updateDailyStatus();
  }

  function onDrawEquipBtnClick() {
    const key = todayKey(); if (localStorage.getItem('daily.equipDrawnAt') === key) return;
    localStorage.setItem('daily.equipDrawnAt', key);
    const unlockable = ALL_EQUIPMENT.filter(item => !player.unlockedItems.has(item.id));
    if(unlockable.length === 0){ showHint(t('hint_all_items')); updateDailyStatus(); return; }
   
    const newItem = unlockable[Math.floor(Math.random() * unlockable.length)];
    player.unlockedItems.add(newItem.id);
    saveState();
    renderAllSheets();
    showHint(t('hint_new_item', {itemName: t(newItem.nameKey)}));
    updateDailyStatus();
  }

  /* =============================
     UI & é¢æ¿ç®¡ç†
  ============================= */
  function togglePanel(panelId, forceOpen) {
      document.querySelectorAll('.sheet').forEach(sheet => {
          const isOpen = forceOpen !== undefined ? forceOpen : !sheet.classList.contains('open');
          if (sheet.id === panelId) {
              sheet.classList.toggle('open', isOpen);
              if (isOpen) {
                 renderAllSheets();
                 if (panelId === 'nameSheet') {
                    $('#nameInput').value = player.name;
                    $('#nameInput').focus();
                 }
              }
          } else {
              sheet.classList.remove('open');
          }
      });
  }
 
  function renderAllSheets() {
      if ($('#gearSheet').classList.contains('open')) renderGearSheet();
      if ($('#petSheet').classList.contains('open')) renderPetSheet();
      if ($('#backpackSheet').classList.contains('open')) renderBackpackSheet();
      if ($('#shopSheet').classList.contains('open')) renderShopSheet();
  }

  function renderGearSheet() {
      const grid = $('#gearGrid'); grid.innerHTML = '';
      ALL_EQUIPMENT.forEach(item => {
          if (player.unlockedItems.has(item.id)) {
              const isEquipped = player.equip[item.type] === item.id;
              grid.innerHTML += `<div class="item"><div><b>${t(item.nameKey)}</b> <span class="badge">${t('type_'+item.type)}</span></div><div class="small">${t(item.descKey)}</div></div><button class="${isEquipped ? 'btn-ok' : ''}" data-equip-id="${item.id}" data-equip-type="${item.type}">${isEquipped ? t('btn_unequip') : t('btn_equip')}</button>`;
          }
      });
  }

  function renderPetSheet() {
      const grid = $('#petGrid'); grid.innerHTML = '';
      ALL_PETS.forEach(p => {
        grid.innerHTML += `<div class="item"><b>${t(p.nameKey)}</b></div><button class="${pet.visible ? 'btn-ok' : ''}" data-pet-id="${p.id}">${pet.visible ? t('btn_unsummon') : t('btn_summon')}</button>`;
      });
  }
 
  function renderBackpackSheet() {
      const grid = $('#backpackGrid'); grid.innerHTML = '';
      let ownedBooks = 0;
      ALL_BOOKS.forEach(book => {
        if(player.inventory.has(book.id)){
          grid.innerHTML += `<div class="item"><b>${t(book.nameKey)}</b></div><button data-book-id="${book.id}">${t('btn_read')}</button>`;
          ownedBooks++;
        }
      });
      if (ownedBooks === 0) {
        grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: var(--muted);">${t('backpack_empty')}</div>`;
      }
  }

  function renderShopSheet() {
      const grid = $('#shopGrid'); grid.innerHTML = '';
      ALL_BOOKS.forEach(book => {
          const owned = player.inventory.has(book.id);
          grid.innerHTML += `<div class="item"><div><b>${t(book.nameKey)}</b></div><div class="small">${owned ? '' : `${t('btn_buy')} ğŸ’°${book.price}`}</div></div><button data-book-id="${book.id}" ${owned ? 'disabled' : ''}>${owned ? t('btn_owned') : t('btn_buy')}</button>`;
      });
  }
 
  $('#gearGrid').addEventListener('click', e => {
    const btn = e.target.closest('button[data-equip-id]'); if (!btn) return;
    const { equipId, equipType } = btn.dataset;
    player.equip[equipType] = (player.equip[equipType] === equipId) ? null : equipId;
    saveState(); renderGearSheet();
  });
 
  $('#petGrid').addEventListener('click', e => {
      const btn = e.target.closest('button[data-pet-id]'); if (!btn) return;
      pet.visible = !pet.visible;
      renderPetSheet();
  });
 
  $('#backpackGrid').addEventListener('click', e => {
      const btn = e.target.closest('button[data-book-id]'); if (!btn) return;
      const book = ALL_BOOKS.find(b => b.id === btn.dataset.bookId);
      if (book && player.inventory.has(book.id)) {
        openBook(book.id);
      }
  });

  $('#shopGrid').addEventListener('click', e => {
      const btn = e.target.closest('button[data-book-id]'); if (!btn) return;
      const book = ALL_BOOKS.find(b => b.id === btn.dataset.bookId);
      if (!book || player.inventory.has(book.id)) return;

      if (player.gold >= book.price) {
          player.gold -= book.price;
          player.inventory.add(book.id);
          saveState();
          updateDailyStatus();
          renderShopSheet();
          showHint(t('hint_buy_book', {price: book.price, bookName: t(book.nameKey)}));
      } else {
          showHint(t('hint_no_gold'));
      }
  });

  /* =============================
     æ›¸ç±é–±è®€å™¨
  ============================= */
  let currentBook = null;
  let currentPage = 0;
  const charsPerPage = 300;

  function openBook(bookId) {
    currentBook = ALL_BOOKS.find(b => b.id === bookId);
    if (!currentBook) return;
    currentPage = 0;
    $('#bookReader').classList.add('open');
    renderPage();
  }

  function renderPage() {
      const content = t(currentBook.contentKey);
      const totalPages = Math.ceil(content.length / charsPerPage);
      const start = currentPage * charsPerPage;
      const end = start + charsPerPage;
      $('#bookTitle').textContent = t(currentBook.nameKey);
      $('#bookContent').textContent = content.substring(start, end);
      $('#pageIndicator').textContent = `${currentPage + 1} / ${totalPages}`;
      $('#prevPageBtn').disabled = currentPage === 0;
      $('#nextPageBtn').disabled = currentPage >= totalPages - 1;
  }
 
  $('#prevPageBtn').addEventListener('click', () => { if(currentPage > 0) { currentPage--; renderPage(); }});
  $('#nextPageBtn').addEventListener('click', () => { 
      const content = t(currentBook.contentKey);
      const totalPages = Math.ceil(content.length / charsPerPage);
      if (currentPage < totalPages - 1) { currentPage++; renderPage(); }
  });
  $('#closeBookBtn').addEventListener('click', () => $('#bookReader').classList.remove('open'));

  /* =============================
     æ™‚é–“ / æ—¥å¤œåœ–ç¤º / æ°£æº«
  ============================= */
  const clockEl = $('#clock'), iconEl  = $('#dayIcon'), tempEl  = $('#temp');

  function tickClock(){
    const now = new Date();
    clockEl.textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    isDay = now.getHours()>=6 && now.getHours()<18;
  }
 
  (async function getTemp(){
    try{
      if (!navigator.geolocation) return;
      const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:false,timeout:6000}));
      const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m&timezone=auto`);
      if (!r.ok) return; const j = await r.json();
      const t = Math.round(j?.current?.temperature_2m);
      if (Number.isFinite(t)) tempEl.textContent = t+"Â°";
    }catch(e){ console.warn("ç„¡æ³•ç²å–å¤©æ°£:", e); }
  })();

  /* =============================
     å•Ÿå‹•
  ============================= */
   
  loadState();
  setLanguage(player.lang || 'zh-TW');
  setInterval(updateCountdown, 1000);
  updateCountdown();
  tickClock(); setInterval(tickClock, 1000 * 60);
  requestAnimationFrame(step);

  $('#langSwitcher').addEventListener('click', () => {
    const currentIndex = LANG_CYCLE.indexOf(currentLang);
    const nextIndex = (currentIndex + 1) % LANG_CYCLE.length;
    setLanguage(LANG_CYCLE[nextIndex]);
    if (localStorage.getItem('daily.usedAt') === todayKey()) {
        const seed = localStorage.getItem('daily.answerSeed');
        const s = pickDailyAnswer(Number(seed));
        showHint(`<b>${t('answer_title')}ï¼š</b>${s}`);
    }
  });

  function fitCanvas(){
    const r = stage.getBoundingClientRect();
    const scale = Math.min(r.width/W, r.height/H);
    map.style.width = `${W*scale|0}px`; map.style.height= `${H*scale|0}px`;
    map.style.left = `${(r.width - W*scale)/2|0}px`; map.style.top  = `${(r.height - H*scale)/2|0}px`;
  }
  new ResizeObserver(fitCanvas).observe(stage);
  fitCanvas();

  dpad.style.display = isTouch ? 'block':'none';

  setInterval(() => {
      if (player.movedSinceLastSave) {
          saveState();
          player.movedSinceLastSave = false;
      }
  }, 1500);
 
  document.querySelectorAll('.close-btn').forEach(btn => {
      btn.addEventListener('click', () => togglePanel(btn.dataset.panel, false));
  });

  $('#answerBtn').addEventListener('click', onAnswerBtnClick);
  $('#drawEquipBtn').addEventListener('click', onDrawEquipBtnClick);
  $('#petBtn').addEventListener('click', () => togglePanel('petSheet'));
  $('#backpackBtn').addEventListener('click', () => togglePanel('backpackSheet'));
  $('#gearBtn').addEventListener('click', () => togglePanel('gearSheet'));
  $('#nameBtn').addEventListener('click', () => togglePanel('nameSheet'));
  
  $('#saveNameBtn').addEventListener('click', () => {
    const newName = $('#nameInput').value.trim();
    if (newName) {
        player.name = newName;
        saveState();
        togglePanel('nameSheet', false);
    }
  });
}

// Check if books.js is loaded, then start the game
if (typeof ALL_BOOKS !== 'undefined' && typeof BOOK_CONTENT !== 'undefined') {
  initializeGame();
} else {
  // Fallback in case the script loading has a delay
  window.addEventListener('load', initializeGame);
}

</script>
</body>
</html>

